name: Summary

on:
  workflow_run:
    workflows: [Lint, Format, Typecheck, Build]
    types: [completed]

permissions:
  pull-requests: write
  actions: read
  checks: read

jobs:
  summary:
    name: Summary
    runs-on: ubuntu-latest
    if: github.event.workflow_run.event == 'pull_request'
    steps:
      - name: Get PR number
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const prs = context.payload.workflow_run.pull_requests;
            if (prs && prs.length > 0) {
              return prs[0].number;
            }
            return null;
          result-encoding: string

      - name: Post summary
        if: steps.pr.outputs.result != 'null'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = parseInt('${{ steps.pr.outputs.result }}');
            const headSha = context.payload.workflow_run.head_sha;
            const workflows = ['Lint', 'Format', 'Typecheck', 'Build'];
            const results = {};

            for (const name of workflows) {
              try {
                const runs = await github.rest.actions.listWorkflowRuns({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  workflow_id: `${name.toLowerCase()}.yml`,
                  head_sha: headSha,
                  per_page: 1
                });

                if (runs.data.workflow_runs.length > 0) {
                  const run = runs.data.workflow_runs[0];
                  results[name] = run.conclusion || run.status;
                } else {
                  results[name] = 'pending';
                }
              } catch (e) {
                results[name] = 'unknown';
              }
            }

            const getStatus = (result) => {
              if (result === 'success') return 'Passed';
              if (result === 'failure') return 'Failed';
              if (result === 'pending' || result === 'in_progress' || result === 'queued') return 'Pending';
              if (result === 'skipped') return 'Skipped';
              if (result === 'cancelled') return 'Cancelled';
              return result || 'Unknown';
            };

            const allDone = Object.values(results).every(r => 
              r === 'success' || r === 'failure' || r === 'skipped' || r === 'cancelled'
            );

            const body = `## CI Summary

            | Check | Result |
            |-------|--------|
            | Lint | ${getStatus(results.Lint)} |
            | Format | ${getStatus(results.Format)} |
            | Typecheck | ${getStatus(results.Typecheck)} |
            | Build | ${getStatus(results.Build)} |

            ${allDone ? '' : '_Some checks still running..._'}
            `;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });

            const existing = comments.find(c => 
              c.user.type === 'Bot' && c.body.includes('## CI Summary')
            );

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: body
              });
            }