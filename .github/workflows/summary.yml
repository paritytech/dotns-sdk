name: Summary

on:
  check_suite:
    types: [completed]

permissions:
  pull-requests: write
  checks: read

jobs:
  summary:
    name: Summary
    runs-on: ubuntu-latest
    if: github.event.check_suite.pull_requests[0] != null
    steps:
      - name: Post summary
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.check_suite.pull_requests[0];
            if (!pr) return;
            
            const prNumber = pr.number;
            const headSha = context.payload.check_suite.head_sha;
            
            await new Promise(r => setTimeout(r, 5000));
            
            const workflows = ['lint', 'format', 'typecheck', 'build'];
            const results = {};

            for (const name of workflows) {
              try {
                const { data: runs } = await github.rest.actions.listWorkflowRuns({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  workflow_id: `${name}.yml`,
                  head_sha: headSha,
                  per_page: 1
                });

                if (runs.workflow_runs.length > 0) {
                  const run = runs.workflow_runs[0];
                  results[name] = run.conclusion || run.status || 'pending';
                } else {
                  results[name] = 'pending';
                }
              } catch (e) {
                results[name] = 'unknown';
              }
            }

            const icon = (r) => r === 'success' ? ':white_check_mark:' : r === 'failure' ? ':x:' : ':hourglass:';
            const text = (r) => r === 'success' ? 'Passed' : r === 'failure' ? 'Failed' : 'Pending';

            const body = `## CI Summary

            | Check | Result |
            |-------|--------|
            | Lint | ${icon(results.lint)} ${text(results.lint)} |
            | Format | ${icon(results.format)} ${text(results.format)} |
            | Typecheck | ${icon(results.typecheck)} ${text(results.typecheck)} |
            | Build | ${icon(results.build)} ${text(results.build)} |
            `;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });

            const existing = comments.find(c => 
              c.user.type === 'Bot' && c.body.includes('## CI Summary')
            );

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: body
              });
            }