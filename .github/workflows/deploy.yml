# Reusable workflow that deploys a static site to Polkadot via the DotNS CLI.
# It uploads the build artifact to Bulletin, optionally registers a base domain
# or preview subname, sets the contenthash, and outputs the resulting CID/URL.
#
# Modes:
#   preview    — registers a subname (e.g. pr42.mysite.dot) under the base domain
#   production — deploys directly to the base domain (e.g. mysite.dot)
name: Deploy on Polkadot

on:
  workflow_call:
    inputs:
      basename:
        description: 'Base domain without .dot'
        required: true
        type: string

      mode:
        description: 'preview (subname deploy) | production (basename deploy)'
        required: false
        type: string
        default: 'preview'

      subname-format:
        description: 'pr-number | branch | sha-short (ignored in production mode)'
        required: false
        type: string
        default: 'pr-number'

      register-base:
        description: 'Register base domain if not owned'
        required: false
        type: boolean
        default: false

      artifact-name:
        description: 'Build artifact to deploy'
        required: true
        type: string

      key-uri:
        description: 'Substrate key URI for dev/test (e.g., //Alice)'
        required: false
        type: string

      bulletin-rpc:
        description: 'Bulletin chain WebSocket RPC endpoint (default: CLI built-in)'
        required: false
        type: string

      rpc:
        description: 'WebSocket RPC endpoint (default: CLI built-in)'
        required: false
        type: string

      cli-version:
        description: 'CLI release tag to install (e.g., v0.1.0)'
        required: false
        type: string
        default: 'v0.1.0'

    secrets:
      mnemonic:
        description: 'BIP39 mnemonic phrase'
        required: false

    outputs:
      cid:
        value: ${{ jobs.deploy.outputs.cid }}
      fqdn:
        value: ${{ jobs.deploy.outputs.fqdn }}
      url:
        value: ${{ jobs.deploy.outputs.url }}

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    outputs:
      cid: ${{ steps.final.outputs.cid }}
      fqdn: ${{ steps.final.outputs.fqdn }}
      url: ${{ steps.final.outputs.url }}

    steps:
      - name: Resolve authentication
        id: auth
        run: |
          AUTH_COUNT=0
          [[ -n "$INPUT_MNEMONIC" ]] && AUTH_COUNT=$((AUTH_COUNT + 1))
          [[ -n "$INPUT_KEY_URI" ]] && AUTH_COUNT=$((AUTH_COUNT + 1))

          if [[ $AUTH_COUNT -eq 0 ]]; then
            echo "::error::No authentication provided. Supply one of: mnemonic or key-uri"
            exit 1
          fi

          if [[ $AUTH_COUNT -gt 1 ]]; then
            echo "::error::Multiple auth methods provided. Supply only one of: mnemonic or key-uri"
            exit 1
          fi

          if [[ -n "$INPUT_MNEMONIC" ]]; then
            echo "::add-mask::$INPUT_MNEMONIC"
            echo "DOTNS_MNEMONIC=$INPUT_MNEMONIC" >> "$GITHUB_ENV"
            echo "method=mnemonic" >> "$GITHUB_OUTPUT"
          elif [[ -n "$INPUT_KEY_URI" ]]; then
            echo "::add-mask::$INPUT_KEY_URI"
            echo "DOTNS_KEY_URI=$INPUT_KEY_URI" >> "$GITHUB_ENV"
            echo "method=key-uri" >> "$GITHUB_OUTPUT"
          fi

          echo "Authentication resolved"
        env:
          INPUT_MNEMONIC: ${{ secrets.mnemonic }}
          INPUT_KEY_URI: ${{ inputs.key-uri }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: '1.2.6'

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.artifact-name }}
          path: build

      - name: Install CLI
        run: |
          gh release download "$CLI_VERSION" -p "*.tgz" -R "$GITHUB_REPOSITORY"
          npm install -g ./dotns-cli-*.tgz
        env:
          GH_TOKEN: ${{ github.token }}
          CLI_VERSION: ${{ inputs.cli-version }}
          GITHUB_REPOSITORY: ${{ github.repository }}

      - name: Resolve target
        id: target
        run: |
          if [[ "$MODE" == "production" ]]; then
            echo "domain=$BASENAME" >> "$GITHUB_OUTPUT"
            echo "fqdn=${BASENAME}.dot" >> "$GITHUB_OUTPUT"
          else
            case "$SUBNAME_FORMAT" in
              pr-number)
                SUBNAME="pr${PR_NUMBER}"
                ;;
              branch)
                SUBNAME=$(echo "$HEAD_REF" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g' | cut -c1-20 | sed 's/-$//')
                ;;
              sha-short)
                SUBNAME=$(echo "$COMMIT_SHA" | cut -c1-7)
                ;;
            esac

            echo "subname=$SUBNAME" >> "$GITHUB_OUTPUT"
            echo "domain=${SUBNAME}.${BASENAME}" >> "$GITHUB_OUTPUT"
            echo "fqdn=${SUBNAME}.${BASENAME}.dot" >> "$GITHUB_OUTPUT"
          fi
        env:
          MODE: ${{ inputs.mode }}
          BASENAME: ${{ inputs.basename }}
          SUBNAME_FORMAT: ${{ inputs.subname-format }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          HEAD_REF: ${{ github.head_ref }}
          COMMIT_SHA: ${{ github.sha }}

      - name: Register base domain
        if: inputs.register-base
        run: dotns register domain --name "$BASENAME"
        continue-on-error: true
        env:
          BASENAME: ${{ inputs.basename }}

      - name: Upload to Bulletin
        id: upload
        run: |
          ARGS=(./build --json)
          [[ -n "$BULLETIN_RPC" ]] && ARGS+=(--bulletin-rpc "$BULLETIN_RPC")

          RESULT=$(dotns bulletin upload "${ARGS[@]}")
          echo "cid=$(echo "$RESULT" | jq -r '.cid')" >> "$GITHUB_OUTPUT"
          echo "contenthash=$(echo "$RESULT" | jq -r '.contenthash')" >> "$GITHUB_OUTPUT"
        env:
          BULLETIN_RPC: ${{ inputs.bulletin-rpc }}

      - name: Register subname
        if: inputs.mode == 'preview'
        run: |
          dotns register subname \
            --name "$SUBNAME" \
            --parent "$BASENAME"
        continue-on-error: true
        env:
          SUBNAME: ${{ steps.target.outputs.subname }}
          BASENAME: ${{ inputs.basename }}

      - name: Set contenthash
        run: |
          ARGS=("$DOMAIN" "$CID")
          [[ -n "$RPC" ]] && ARGS+=(--rpc "$RPC")

          dotns content set "${ARGS[@]}"
        env:
          DOMAIN: ${{ steps.target.outputs.domain }}
          CID: ${{ steps.upload.outputs.cid }}
          RPC: ${{ inputs.rpc }}

      - name: Set outputs
        id: final
        run: |
          echo "cid=$CID" >> "$GITHUB_OUTPUT"
          echo "fqdn=$FQDN" >> "$GITHUB_OUTPUT"
          echo "url=https://${DOMAIN}.paseo.li" >> "$GITHUB_OUTPUT"
        env:
          CID: ${{ steps.upload.outputs.cid }}
          FQDN: ${{ steps.target.outputs.fqdn }}
          DOMAIN: ${{ steps.target.outputs.domain }}

      - name: Summary
        run: |
          cat >> "$GITHUB_STEP_SUMMARY" <<EOF
          ## Deployment Complete

          | Property | Value |
          |----------|-------|
          | Mode | \`${MODE}\` |
          | Domain | \`${FQDN}\` |
          | CID | \`${CID}\` |
          | URL | [${URL}](${URL}) |
          | Auth | ${AUTH_METHOD} |
          EOF
        env:
          MODE: ${{ inputs.mode }}
          FQDN: ${{ steps.final.outputs.fqdn }}
          CID: ${{ steps.final.outputs.cid }}
          URL: ${{ steps.final.outputs.url }}
          AUTH_METHOD: ${{ steps.auth.outputs.method }}