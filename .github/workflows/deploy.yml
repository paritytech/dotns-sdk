# Reusable workflow that deploys a static site to Polkadot via the DotNS CLI.
# It uploads the build artifact to Bulletin, optionally registers a base domain
# or preview subname, sets the contenthash, and outputs the resulting CID/URL.
#
# The workflow is structured as discrete stages so that a failure at any point
# (e.g. contenthash update) does not force earlier stages (e.g. upload) to re-run.
# A content-addressable cache skips the upload entirely when the build hasn't changed.
# Lookup steps check name existence before registration to avoid redundant retries
# and to fail fast with actionable error messages when prerequisites are missing.
#
# Bulletin-specific steps (authorize, upload) and DotNS-specific steps (lookup,
# register, contenthash) are encapsulated in composite actions under .github/actions/.
#
# Modes:
#   preview    — registers a subname (e.g. pr42.mysite.dot) under the base domain
#   production — deploys directly to the base domain (e.g. mysite.dot)
name: Deploy on Polkadot

on:
  workflow_call:
    inputs:
      basename:
        description: 'Base domain without .dot'
        required: true
        type: string

      mode:
        description: 'preview (subname deploy) | production (basename deploy)'
        required: false
        type: string
        default: 'preview'

      subname-format:
        description: 'pr-number | branch | sha-short (ignored in production mode)'
        required: false
        type: string
        default: 'pr-number'

      register-base:
        description: 'Attempt base domain registration if not already owned'
        required: false
        type: boolean
        default: false

      artifact-name:
        description: 'Build artifact to deploy'
        required: true
        type: string

      key-uri:
        description: 'Substrate key URI for dev/test (e.g., //Alice)'
        required: false
        type: string

      bulletin-rpc:
        description: 'Bulletin chain WebSocket RPC endpoint (default: CLI built-in)'
        required: false
        type: string

      rpc:
        description: 'WebSocket RPC endpoint (default: CLI built-in)'
        required: false
        type: string

      parallel:
        description: 'Upload directory blocks in parallel'
        required: false
        type: boolean
        default: true

      upload-concurrency:
        description: 'Number of parallel block uploads'
        required: false
        type: number
        default: 15

      skip-cache:
        description: 'Skip deployment cache and force re-upload'
        required: false
        type: boolean
        default: false

      max-retries:
        description: 'Max retry attempts per step for transient RPC failures'
        required: false
        type: number
        default: 3

      retry-delay:
        description: 'Seconds to wait between retries'
        required: false
        type: number
        default: 15

    secrets:
      dotns-mnemonic:
        description: 'BIP39 mnemonic for DotNS on-chain operations (register, contenthash)'
        required: true

      bulletin-mnemonic:
        description: 'BIP39 mnemonic for Bulletin uploads (defaults to //Alice dev seed)'
        required: false

      dotns-token:
        description: 'PAT with read access to dotns-sdk (cross-repo checkout)'
        required: false

    outputs:
      cid:
        value: ${{ jobs.deploy.outputs.cid }}
      fqdn:
        value: ${{ jobs.deploy.outputs.fqdn }}
      url:
        value: ${{ jobs.deploy.outputs.url }}
      cache-hit:
        value: ${{ jobs.deploy.outputs.cache-hit }}

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    outputs:
      cid: ${{ steps.final.outputs.cid }}
      fqdn: ${{ steps.final.outputs.fqdn }}
      url: ${{ steps.final.outputs.url }}
      cache-hit: ${{ steps.cache.outputs.cache-hit }}

    steps:
      - name: Checkout actions
        uses: actions/checkout@v4
        with:
          repository: paritytech/dotns-sdk
          ref: ${{ github.job_workflow_sha }}
          token: ${{ secrets.dotns-token || github.token }}
          sparse-checkout: |
            .github/actions
            packages/cli
            packages/sdk
            package.json
            bun.lock

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: '1.2.6'

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.artifact-name }}
          path: build

      - name: Setup CLI
        uses: ./.github/actions/setup-cli

      - name: Resolve target
        id: target
        run: |
          if [[ "$MODE" == "production" ]]; then
            echo "domain=$BASENAME" >> "$GITHUB_OUTPUT"
            echo "fqdn=${BASENAME}.dot" >> "$GITHUB_OUTPUT"
          else
            case "$SUBNAME_FORMAT" in
              pr-number)
                SUBNAME="pr${PR_NUMBER}"
                ;;
              branch)
                SUBNAME=$(echo "$HEAD_REF" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g' | cut -c1-20 | sed 's/-$//')
                ;;
              sha-short)
                SUBNAME=$(echo "$COMMIT_SHA" | cut -c1-7)
                ;;
            esac

            echo "subname=$SUBNAME" >> "$GITHUB_OUTPUT"
            echo "domain=${SUBNAME}.${BASENAME}" >> "$GITHUB_OUTPUT"
            echo "fqdn=${SUBNAME}.${BASENAME}.dot" >> "$GITHUB_OUTPUT"
          fi
        env:
          MODE: ${{ inputs.mode }}
          BASENAME: ${{ inputs.basename }}
          SUBNAME_FORMAT: ${{ inputs.subname-format }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          HEAD_REF: ${{ github.head_ref }}
          COMMIT_SHA: ${{ github.sha }}

      - name: Compute build hash
        id: hash
        run: |
          HASH=$(find build -type f -exec sha256sum {} \; | sort | sha256sum | cut -d' ' -f1)
          echo "hash=$HASH" >> "$GITHUB_OUTPUT"
          echo "Build hash: $HASH"

      - name: Check deployment cache
        id: cache
        if: inputs.skip-cache != true
        uses: actions/cache@v4
        with:
          path: .deploy-cache
          key: deploy-${{ steps.hash.outputs.hash }}

      - name: Load cached CID
        id: cached
        if: steps.cache.outputs.cache-hit == 'true'
        run: |
          CID=$(cat .deploy-cache/cid)
          echo "cid=$CID" >> "$GITHUB_OUTPUT"
          echo "::notice::Cache hit — reusing CID: $CID"

      - name: Upload to Bulletin
        id: bulletin
        if: steps.cache.outputs.cache-hit != 'true'
        uses: ./.github/actions/bulletin
        with:
          mnemonic: ${{ secrets.bulletin-mnemonic || 'bottom drive obey lake curtain smoke basket hold race lonely fit walk' }}
          bulletin-rpc: ${{ inputs.bulletin-rpc }}
          build-path: ./build
          parallel: ${{ inputs.parallel }}
          upload-concurrency: ${{ inputs.upload-concurrency }}
          max-retries: ${{ inputs.max-retries }}
          retry-delay: ${{ inputs.retry-delay }}

      - name: Save CID to cache
        if: steps.cache.outputs.cache-hit != 'true' && steps.bulletin.outputs.cid != ''
        run: |
          mkdir -p .deploy-cache
          echo "$CID" > .deploy-cache/cid
        env:
          CID: ${{ steps.bulletin.outputs.cid }}

      - name: Resolve CID
        id: cid
        run: |
          CID="${CACHED_CID:-$UPLOAD_CID}"

          if [[ -z "$CID" ]]; then
            echo "::error::No CID available from cache or upload"
            exit 1
          fi

          echo "cid=$CID" >> "$GITHUB_OUTPUT"
        env:
          CACHED_CID: ${{ steps.cached.outputs.cid }}
          UPLOAD_CID: ${{ steps.bulletin.outputs.cid }}

      - name: Register and set contenthash
        uses: ./.github/actions/dotns
        with:
          mnemonic: ${{ secrets.dotns-mnemonic }}
          rpc: ${{ inputs.rpc }}
          basename: ${{ inputs.basename }}
          mode: ${{ inputs.mode }}
          subname: ${{ steps.target.outputs.subname }}
          domain: ${{ steps.target.outputs.domain }}
          register-base: ${{ inputs.register-base }}
          cid: ${{ steps.cid.outputs.cid }}
          max-retries: ${{ inputs.max-retries }}
          retry-delay: ${{ inputs.retry-delay }}

      - name: Set outputs
        id: final
        run: |
          echo "cid=$CID" >> "$GITHUB_OUTPUT"
          echo "fqdn=$FQDN" >> "$GITHUB_OUTPUT"
          echo "url=https://${DOMAIN}.paseo.li" >> "$GITHUB_OUTPUT"
        env:
          CID: ${{ steps.cid.outputs.cid }}
          FQDN: ${{ steps.target.outputs.fqdn }}
          DOMAIN: ${{ steps.target.outputs.domain }}

      - name: Summary
        run: |
          CACHE_NOTE=""
          if [[ "$CACHE_HIT" == "true" ]]; then
            CACHE_NOTE=" (cached)"
          fi

          BULLETIN_AUTH="mnemonic"
          if [[ -z "$BULLETIN_MNEMONIC" ]]; then
            BULLETIN_AUTH="alice"
          fi

          cat >> "$GITHUB_STEP_SUMMARY" <<EOF
          ## Deployment Complete

          | Property | Value |
          |----------|-------|
          | Mode | \`${MODE}\` |
          | Domain | \`${FQDN}\` |
          | CID | \`${CID}\`${CACHE_NOTE} |
          | URL | [${URL}](${URL}) |
          | Bulletin Auth | ${BULLETIN_AUTH} |
          EOF
        env:
          MODE: ${{ inputs.mode }}
          FQDN: ${{ steps.final.outputs.fqdn }}
          CID: ${{ steps.final.outputs.cid }}
          URL: ${{ steps.final.outputs.url }}
          BULLETIN_MNEMONIC: ${{ secrets.bulletin-mnemonic }}
          CACHE_HIT: ${{ steps.cache.outputs.cache-hit }}
